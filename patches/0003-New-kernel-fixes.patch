From 491ca46f6096de4046b5145c1484f32e99fe1760 Mon Sep 17 00:00:00 2001
From: Alice Heather <AliceHeather64@gmail.com>
Date: Thu, 23 Oct 2025 09:56:52 +0200
Subject: [PATCH 3/3] New kernel fixes

---
 hal/led/hal_led.c             |  2 +-
 os_dep/linux/ioctl_cfg80211.c | 13 +++++++++++--
 os_dep/linux/usb_intf.c       |  4 ++++
 os_dep/linux/wifi_regd.c      |  2 +-
 4 files changed, 17 insertions(+), 4 deletions(-)

diff --git a/hal/led/hal_led.c b/hal/led/hal_led.c
index 95d3daa..2a753f9 100644
--- a/hal/led/hal_led.c
+++ b/hal/led/hal_led.c
@@ -63,7 +63,7 @@ void rtw_led_set_strategy(_adapter *adapter, u8 strategy)
 	rtw_hal_sw_led_deinit(pri_adapter);
 #endif
 
-	rtw_led_control(pri_adapter, RTW_LED_OFF);
+	rtw_led_control(pri_adapter, LED_CTL_POWER_OFF);
 }
 
 #ifdef CONFIG_RTW_SW_LED
diff --git a/os_dep/linux/ioctl_cfg80211.c b/os_dep/linux/ioctl_cfg80211.c
index bf2f5a5..62513f8 100644
--- a/os_dep/linux/ioctl_cfg80211.c
+++ b/os_dep/linux/ioctl_cfg80211.c
@@ -5393,15 +5393,21 @@ exit:
 	return ret;
 }
 
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 4, 0))
+static int cfg80211_rtw_change_beacon(struct wiphy *wiphy, struct net_device *ndev,
+		struct cfg80211_ap_update *info)
+#else
 static int cfg80211_rtw_change_beacon(struct wiphy *wiphy, struct net_device *ndev,
 		struct cfg80211_beacon_data *info)
+#endif
 {
 	int ret = 0;
 	_adapter *adapter = (_adapter *)rtw_netdev_priv(ndev);
 
 	RTW_INFO(FUNC_NDEV_FMT"\n", FUNC_NDEV_ARG(ndev));
 
-	ret = rtw_add_beacon(adapter, info->head, info->head_len, info->tail, info->tail_len);
+	struct cfg80211_beacon_data* beacon = &info->beacon;
+	ret = rtw_add_beacon(adapter, beacon->head, beacon->head_len, beacon->tail, beacon->tail_len);
 
 	return ret;
 }
@@ -6882,7 +6888,10 @@ static void rtw_get_chbwoff_from_cfg80211_chan_def(
 #endif /* (LINUX_VERSION_CODE >= KERNEL_VERSION(3, 8, 0)) */
 
 static int cfg80211_rtw_set_monitor_channel(struct wiphy *wiphy
-#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3, 8, 0))
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 5, 0))
+	, struct net_device *
+	, struct cfg80211_chan_def *chandef
+#elif (LINUX_VERSION_CODE >= KERNEL_VERSION(3, 8, 0))
 	, struct cfg80211_chan_def *chandef
 #else
 	, struct ieee80211_channel *chan
diff --git a/os_dep/linux/usb_intf.c b/os_dep/linux/usb_intf.c
index 572b8ff..d123a86 100644
--- a/os_dep/linux/usb_intf.c
+++ b/os_dep/linux/usb_intf.c
@@ -347,6 +347,10 @@ struct rtw_usb_drv usb_drv = {
 	.usbdrv.reset_resume   = rtw_resume,
 #endif
 
+// #if (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 7, 0))
+// 	.usbdrv.drvwrap.driver.shutdown = rtw_dev_shutdown,
+// #elif (LINUX_VERSION_CODE >= KERNEL_VERSION(6, 6, 0))
+// 	.usbdrv.driver.shutdown = rtw_dev_shutdown,
 #if (LINUX_VERSION_CODE >= KERNEL_VERSION(2, 6, 19))
 	.usbdrv.drvwrap.driver.shutdown = rtw_dev_shutdown,
 #else
diff --git a/os_dep/linux/wifi_regd.c b/os_dep/linux/wifi_regd.c
index 81e1dc7..609fe20 100644
--- a/os_dep/linux/wifi_regd.c
+++ b/os_dep/linux/wifi_regd.c
@@ -405,7 +405,7 @@ int rtw_regd_init(struct wiphy *wiphy)
 	wiphy->regulatory_flags &= ~REGULATORY_DISABLE_BEACON_HINTS;
 #endif
 
-#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3, 19, 0))
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(3, 19, 0) && LINUX_VERSION_CODE < KERNEL_VERSION(6, 4, 0))
 	wiphy->regulatory_flags |= REGULATORY_IGNORE_STALE_KICKOFF;
 #endif
 
-- 
2.51.1.dirty

